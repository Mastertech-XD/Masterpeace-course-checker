<!DOCTYPE html>
<html lang="en">
<head>
  <!-- All your existing head content remains exactly the same -->
  <!-- Only adding new CSS for admin actions and password recovery -->
  <style>
    /* Add these new styles for admin actions */
    .admin-action-btn {
      padding: 5px 10px;
      background: rgba(220, 53, 69, 0.7);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
    }
    
    .admin-action-btn:hover {
      background: rgba(220, 53, 69, 0.9);
    }
    
    /* Password strength meter */
    .password-strength {
      height: 5px;
      margin-top: 5px;
      border-radius: 2px;
      transition: width 0.3s, background-color 0.3s;
    }
    
    /* Session timeout warning */
    .session-timeout-warning {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Your existing HTML content remains exactly the same until before the closing </body> tag -->

  <!-- Add these new modals before the closing </body> tag -->
  <!-- Forgot Password Modal -->
  <div class="modal" id="forgotPasswordModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">
          <i class="fas fa-key"></i> Password Recovery
        </div>
        <button class="close-modal" id="closeForgotPasswordModal">&times;</button>
      </div>
      <form class="login-form" id="forgotPasswordForm">
        <div class="form-group">
          <label class="form-label">Email or KUCCPS Number</label>
          <input type="text" class="form-input" id="recoveryEmail" placeholder="Enter your email or KUCCPS number" required>
        </div>
        <button type="submit" class="form-submit">Send Recovery Link</button>
        <div class="form-footer">
          Remember your password? <a href="#" class="form-link" id="showLoginFromRecovery">Login</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div class="modal" id="resetPasswordModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">
          <i class="fas fa-key"></i> Reset Password
        </div>
        <button class="close-modal" id="closeResetPasswordModal">&times;</button>
      </div>
      <form class="login-form" id="resetPasswordForm">
        <input type="hidden" id="resetToken">
        <div class="form-group">
          <label class="form-label">New Password</label>
          <div class="password-container">
            <input type="password" class="form-input" id="newPassword" placeholder="Enter new password" required>
            <button type="button" class="toggle-password">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div class="password-strength" id="passwordStrength"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Confirm New Password</label>
          <div class="password-container">
            <input type="password" class="form-input" id="confirmNewPassword" placeholder="Confirm new password" required>
            <button type="button" class="toggle-password">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        <button type="submit" class="form-submit">Reset Password</button>
      </form>
    </div>
  </div>

  <!-- Update Admin Panel Modal to include active users tab -->
  <div class="modal" id="adminPanelModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">
          <i class="fas fa-cogs"></i> Admin Panel
        </div>
        <button class="close-modal" id="closeAdminPanel">&times;</button>
      </div>
      <div class="admin-panel-content">
        <h3><i class="fas fa-users"></i> User Management</h3>
        
        <div class="admin-tabs">
          <button class="admin-tab active" onclick="openAdminTab('users')">Users</button>
          <button class="admin-tab" onclick="openAdminTab('logins')">Login History</button>
          <button class="admin-tab" onclick="openAdminTab('active')">Active Sessions</button>
          <button class="admin-tab" onclick="openAdminTab('notifications')">Notifications</button>
        </div>
        
        <div id="usersTab" class="admin-tab-content active">
          <h4>Registered Users</h4>
          <div style="max-height: 200px; overflow-y: auto;">
            <table>
              <thead>
                <tr>
                  <th>Email</th>
                  <th>KUCCPS No.</th>
                  <th>Registered</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="adminUserList">
                <!-- Filled by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div id="loginsTab" class="admin-tab-content">
          <h4>Login History</h4>
          <div style="max-height: 200px; overflow-y: auto;">
            <table>
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Timestamp</th>
                  <th>IP Address</th>
                  <th>Location</th>
                </tr>
              </thead>
              <tbody id="adminLoginList">
                <!-- Filled by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div id="activeTab" class="admin-tab-content">
          <h4>Currently Active Users</h4>
          <div style="max-height: 200px; overflow-y: auto;">
            <table>
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Login Time</th>
                  <th>Location</th>
                  <th>Device</th>
                </tr>
              </thead>
              <tbody id="adminActiveUsersList"></tbody>
            </table>
          </div>
        </div>
        
        <div id="notificationsTab" class="admin-tab-content">
          <h4>Manage Notifications</h4>
          <div class="form-group">
            <label class="form-label">Notification Title</label>
            <input type="text" class="form-input" id="notificationTitle" placeholder="Enter title">
          </div>
          <div class="form-group">
            <label class="form-label">Notification Content</label>
            <textarea class="form-input" id="notificationContent" rows="3" placeholder="Enter content"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Notification Time</label>
            <input type="text" class="form-input" id="notificationTime" placeholder="e.g. 2 hours ago">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="notificationUnread"> Mark as unread
            </label>
          </div>
          <button class="form-submit" id="addNotificationBtn">
            <i class="fas fa-plus"></i> Add Notification
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Session timeout warning -->
  <div class="session-timeout-warning" id="sessionTimeoutWarning">
    Your session will expire in <span id="timeoutCounter">2:00</span>. Click to extend.
  </div>

  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    // Enhanced security version with password recovery and admin monitoring
    const SECURITY = {
      SESSION_TIMEOUT: 30 * 60 * 1000, // 30 minutes
      PASSWORD_RESET_EXPIRY: 3600000, // 1 hour
      MIN_PASSWORD_LENGTH: 8,
      MAX_LOGIN_ATTEMPTS: 5,
      LOCKOUT_DURATION: 15 * 60 * 1000 // 15 minutes
    };

    let users = JSON.parse(localStorage.getItem('kuccps_users')) || [
      { 
        id: crypto.randomUUID(),
        email: 'student@example.com', 
        kuccpsNumber: 'KCPS12345', 
        password: hashPassword('password123'), 
        createdAt: new Date().toISOString(),
        lastLogin: null,
        failedAttempts: 0,
        lockedUntil: null
      }
    ];
    
    let loginHistory = JSON.parse(localStorage.getItem('kuccps_login_history')) || [];
    let userSessions = JSON.parse(localStorage.getItem('kuccps_user_sessions')) || [];
    let notifications = JSON.parse(localStorage.getItem('kuccps_notifications')) || [];
    let sessionTimer;

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Your existing initialization code
      if (typeof particlesJS !== 'undefined') {
        particlesJS('particles-js', {
          particles: {
            number: { value: 80, density: { enable: true, value_area: 800 } },
            color: { value: "#0ff" },
            shape: { type: "circle" },
            opacity: { value: 0.5, random: true },
            size: { value: 3, random: true },
            line_linked: { enable: true, distance: 150, color: "#0ff", opacity: 0.4, width: 1 },
            move: { enable: true, speed: 2, direction: "none", random: true, straight: false, out_mode: "out" }
          },
          interactivity: {
            detect_on: "canvas",
            events: {
              onhover: { enable: true, mode: "repulse" },
              onclick: { enable: true, mode: "push" }
            }
          }
        });
      }
      
      createRain();
      setupEventListeners();
      showLoader();
      setTimeout(hideLoader, 1500);
      setTimeout(showCookieConsent, 3000);
      checkScrollPosition();
      checkLoginStatus();
      
      // Add these new initializations
      initPasswordRecovery();
      initSessionTracking();
      checkAutoLogout();
      
      // Check for reset token in URL
      checkPasswordResetToken();
    });

    // ==================== Security Functions ====================
    function hashPassword(password) {
      return CryptoJS.SHA256(password + "KUCCPS_SALT").toString();
    }

    function generateSecureToken() {
      const array = new Uint32Array(10);
      window.crypto.getRandomValues(array);
      return array.join('-');
    }

    function validatePassword(password) {
      if (password.length < SECURITY.MIN_PASSWORD_LENGTH) return false;
      // Add more complexity rules as needed
      return true;
    }

    function updatePasswordStrength(password) {
      const strengthBar = document.getElementById('passwordStrength');
      if (!strengthBar) return;
      
      const strength = Math.min(password.length / 12 * 100, 100);
      strengthBar.style.width = strength + '%';
      
      if (password.length < 6) {
        strengthBar.style.backgroundColor = '#dc3545'; // Red
      } else if (password.length < 10) {
        strengthBar.style.backgroundColor = '#ffc107'; // Yellow
      } else {
        strengthBar.style.backgroundColor = '#28a745'; // Green
      }
    }

    // ==================== Session Management ====================
    function initSessionTracking() {
      const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
      if (currentUser) {
        trackUserLogin(currentUser);
        startSessionTimer();
      }
    }

    function startSessionTimer() {
      resetSessionTimer();
      document.addEventListener('mousemove', resetSessionTimer);
      document.addEventListener('keypress', resetSessionTimer);
    }

    function resetSessionTimer() {
      clearTimeout(sessionTimer);
      sessionTimer = setTimeout(showSessionTimeoutWarning, SECURITY.SESSION_TIMEOUT - 60000); // Warn 1 min before
    }

    function showSessionTimeoutWarning() {
      const warning = document.getElementById('sessionTimeoutWarning');
      let seconds = 60;
      
      warning.style.display = 'block';
      warning.addEventListener('click', extendSession);
      
      const countdown = setInterval(() => {
        document.getElementById('timeoutCounter').textContent = `0:${seconds < 10 ? '0' : ''}${seconds}`;
        seconds--;
        
        if (seconds < 0) {
          clearInterval(countdown);
          logoutUser();
        }
      }, 1000);
    }

    function extendSession() {
      clearTimeout(sessionTimer);
      document.getElementById('sessionTimeoutWarning').style.display = 'none';
      startSessionTimer();
    }

    // ==================== Password Recovery ====================
    function initPasswordRecovery() {
      // Forgot password link
      document.getElementById('forgotPassword').addEventListener('click', (e) => {
        e.preventDefault();
        hideModal('loginModal');
        showModal('forgotPasswordModal');
      });
      
      // Back to login from recovery
      document.getElementById('showLoginFromRecovery').addEventListener('click', (e) => {
        e.preventDefault();
        hideModal('forgotPasswordModal');
        showModal('loginModal');
      });
      
      // Close buttons for new modals
      document.getElementById('closeForgotPasswordModal').addEventListener('click', () => hideModal('forgotPasswordModal'));
      document.getElementById('closeResetPasswordModal').addEventListener('click', () => hideModal('resetPasswordModal'));
      
      // Password strength meter
      document.getElementById('newPassword')?.addEventListener('input', function() {
        updatePasswordStrength(this.value);
      });
      
      // Forgot password form
      document.getElementById('forgotPasswordForm').addEventListener('submit', handleForgotPassword);
      
      // Reset password form
      document.getElementById('resetPasswordForm').addEventListener('submit', handlePasswordReset);
    }

    function handleForgotPassword(e) {
      e.preventDefault();
      const identifier = document.getElementById('recoveryEmail').value;
      const user = users.find(u => u.email === identifier || u.kuccpsNumber === identifier);
      
      if (user) {
        if (user.lockedUntil && new Date(user.lockedUntil) > new Date()) {
          alert('Account is temporarily locked. Please try again later.');
          return;
        }
        
        const resetToken = generateSecureToken();
        user.resetToken = resetToken;
        user.resetTokenExpiry = Date.now() + SECURITY.PASSWORD_RESET_EXPIRY;
        localStorage.setItem('kuccps_users', JSON.stringify(users));
        
        // Simulate email sending
        setTimeout(() => {
          alert(`Password reset link has been sent to ${user.email}`);
        }, 1000);
        
        hideModal('forgotPasswordModal');
      } else {
        alert('No account found with that email or KUCCPS number');
      }
    }

    function checkPasswordResetToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const resetToken = urlParams.get('resetToken');
      
      if (resetToken) {
        const user = users.find(u => 
          u.resetToken === resetToken && 
          u.resetTokenExpiry > Date.now()
        );
        
        if (user) {
          document.getElementById('resetToken').value = resetToken;
          showModal('resetPasswordModal');
          window.history.replaceState({}, document.title, window.location.pathname);
        } else {
          alert('Invalid or expired reset token');
        }
      }
    }

    function handlePasswordReset(e) {
      e.preventDefault();
      const token = document.getElementById('resetToken').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmNewPassword').value;
      
      if (newPassword !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      
      if (!validatePassword(newPassword)) {
        alert(`Password must be at least ${SECURITY.MIN_PASSWORD_LENGTH} characters long`);
        return;
      }
      
      const user = users.find(u => u.resetToken === token);
      
      if (user) {
        user.password = hashPassword(newPassword);
        delete user.resetToken;
        delete user.resetTokenExpiry;
        user.failedAttempts = 0;
        user.lockedUntil = null;
        
        localStorage.setItem('kuccps_users', JSON.stringify(users));
        alert('Password reset successfully! Please login with your new password.');
        hideModal('resetPasswordModal');
        showModal('loginModal');
      } else {
        alert('Invalid or expired reset token');
      }
    }

    // ==================== User Tracking ====================
    function trackUserLogin(user) {
      // Check if user already has an active session
      const existingSessionIndex = userSessions.findIndex(session => 
        session.userId === user.id && session.isActive);
      
      if (existingSessionIndex >= 0) {
        // Update last activity time
        userSessions[existingSessionIndex].lastActivity = new Date().toISOString();
      } else {
        // Create new session
        const session = {
          userId: user.id,
          email: user.email,
          kuccpsNumber: user.kuccpsNumber,
          ip: "192.168.1.1", // In production, get actual IP from request
          location: "Nairobi, Kenya", // In production, use geolocation API
          device: navigator.userAgent,
          loginTime: new Date().toISOString(),
          lastActivity: new Date().toISOString(),
          isActive: true
        };
        
        userSessions.push(session);
      }
      
      localStorage.setItem('kuccps_user_sessions', JSON.stringify(userSessions));
    }

    // ==================== Admin Functions ====================
    function loadAdminData() {
      loadUserList();
      loadLoginHistory();
      loadActiveSessions();
      loadNotifications();
    }

    function loadUserList() {
      const userList = document.getElementById('adminUserList');
      userList.innerHTML = users.map(user => `
        <tr>
          <td>${user.email}</td>
          <td>${user.kuccpsNumber}</td>
          <td>${new Date(user.createdAt).toLocaleDateString()}</td>
          <td>
            <button class="admin-action-btn" onclick="adminResetPassword('${user.id}')">
              Reset Password
            </button>
            ${user.lockedUntil && new Date(user.lockedUntil) > new Date() ? 
              `<button class="admin-action-btn" onclick="adminUnlockAccount('${user.id}')">
                Unlock
              </button>` : ''}
          </td>
        </tr>
      `).join('');
    }

    function adminResetPassword(userId) {
      if (confirm('Are you sure you want to reset this user\'s password?')) {
        const user = users.find(u => u.id === userId);
        if (user) {
          // Generate temporary password
          const tempPassword = `temp${Math.random().toString(36).substr(2, 8)}`;
          user.password = hashPassword(tempPassword);
          user.failedAttempts = 0;
          user.lockedUntil = null;
          localStorage.setItem('kuccps_users', JSON.stringify(users));
          
          // In production, send email to user with temp password
          alert(`Password reset for ${user.email}. Temporary password: ${tempPassword}`);
          
          // Reload admin data to reflect changes
          loadUserList();
        }
      }
    }

    function adminUnlockAccount(userId) {
      const user = users.find(u => u.id === userId);
      if (user) {
        user.lockedUntil = null;
        user.failedAttempts = 0;
        localStorage.setItem('kuccps_users', JSON.stringify(users));
        loadUserList();
        alert('Account unlocked successfully');
      }
    }

    function loadLoginHistory() {
      const loginList = document.getElementById('adminLoginList');
      loginList.innerHTML = loginHistory.map(entry => `
        <tr>
          <td>${entry.email}</td>
          <td>${new Date(entry.timestamp).toLocaleString()}</td>
          <td>${entry.ip}</td>
          <td>${entry.location || 'Unknown'}</td>
        </tr>
      `).join('');
    }

    function loadActiveSessions() {
      const activeUsersList = document.getElementById('adminActiveUsersList');
      activeUsersList.innerHTML = userSessions
        .filter(session => session.isActive)
        .map(session => `
          <tr>
            <td>${session.email}</td>
            <td>${new Date(session.loginTime).toLocaleTimeString()}</td>
            <td>${session.location}</td>
            <td>${session.device.substring(0, 30)}...</td>
          </tr>
        `).join('');
    }

    function loadNotifications() {
      // Your existing notification loading logic
    }

    // ==================== Modified Existing Functions ====================
    // Update the setupEventListeners function to include password recovery
    const originalSetupEventListeners = setupEventListeners;
    setupEventListeners = function() {
      originalSetupEventListeners();
      
      // Add these new event listeners
      document.getElementById('forgotPassword').addEventListener('click', (e) => {
        e.preventDefault();
        hideModal('loginModal');
        showModal('forgotPasswordModal');
      });
      
      document.getElementById('showLoginFromRecovery').addEventListener('click', (e) => {
        e.preventDefault();
        hideModal('forgotPasswordModal');
        showModal('loginModal');
      });
    };

    // Update checkLoginStatus to track user sessions
    const originalCheckLoginStatus = checkLoginStatus;
    checkLoginStatus = function() {
      originalCheckLoginStatus();
      const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
      if (currentUser) {
        trackUserLogin(currentUser);
      }
    };

    // Your remaining existing JavaScript functions remain exactly the same
    // Only the new/modified functions are shown above
  </script>
</body>
</html>
